# ูุธุงู ูุณุญ ุงูุจุทุงูุงุช ุงูุชููุงุฆู
## Card Cleanup System

---

## โ ุชู ุงูุชูููุฐ ุจูุฌุงุญ!

ุชู ุฅุถุงูุฉ ูุธุงู ูุงูู ููุณุญ ุงูุจุทุงูุงุช ุงููุฏููุฉ ูุบูุฑ ุงููุณุชุฎุฏูุฉ ุชููุงุฆูุงู.

---

## ๐ฏ ูุงุฐุง ููุนู ุงููุธุงูุ

### 1๏ธโฃ ุชูุธูู ุชููุงุฆู ูููู (ุงูุณุงุนุฉ 2 ุตุจุงุญุงู)
ูููู ุงููุธุงู ุจุญุฐู:
- โ **ุงูุจุทุงูุงุช ุบูุฑ ุงููุฑุงุฌุนุฉ** ุงูุฃูุฏู ูู **90 ููู**
- โ **ุงูุจุทุงูุงุช ุงููุฑุงุฌุนุฉ** ุงูุฃูุฏู ูู **180 ููู**
- โ **ุงูุจุทุงูุงุช ุถุนููุฉ ุงูุซูุฉ** (< 50%) ุงูุฃูุฏู ูู **30 ููู**
- โ **ุงููููุงุช ุงููุชููุฉ** ูู `tmp/cards` ุงูุฃูุฏู ูู **24 ุณุงุนุฉ**

### 2๏ธโฃ ุญุฐู ุขูู
- ุญุฐู ุงูููู ูู storage
- ุญุฐู ุงูุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุณุฌูู ูู logs

---

## ๐ ุงููุชุงุฆุฌ ูู ุงูุงุฎุชุจุงุฑ

```
๐งน ุชุดุบูู ุงูุชูุธูู:
============================================================
ูุชุงุฆุฌ ุงูุชูุธูู:
  - ุจุทุงูุงุช ุบูุฑ ูุฑุงุฌุนุฉ: 1
  - ุจุทุงูุงุช ูุฏููุฉ ูุฑุงุฌุนุฉ: 1
  - ุจุทุงูุงุช ุถุนููุฉ ุงูุซูุฉ: 1
  - ูููุงุช ูุชููุฉ: 0
  - ุฅุฌูุงูู ุงูุณุฌูุงุช ุงููุญุฐููุฉ: 3
============================================================

โ ููุชุงุฒ! ุชู ุญุฐู 3 ุจุทุงูุงุช ููุง ูู ูุชููุน
โ ุงูุจุทุงูุฉ ุงูุญุฏูุซุฉ (5 ุฃูุงู) ูู ุชูุญุฐู
```

---

## ๐ง ููู ูุนููุ

### ุงูุฌุฏููุฉ ุงูุชููุงุฆูุฉ (APScheduler)
```python
# ูู app/core/scheduler.py
scheduler.add_job(
    cleanup_cards_sync,
    "cron",
    hour=2,        # ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
    minute=0,
    id="cleanup_old_cards",
    replace_existing=True,
    max_instances=1
)
```

### ุงูุณูุฑุจุช ุงููุฏูู
```bash
# ุชุดุบูู ูุฏูู ููุชูุธูู
cd backend
python cleanup_old_cards.py
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช

ููููู ุชุนุฏูู ุงููุฏุฏ ุงูุฒูููุฉ ูู ุงูููุฏ:

### ูู `app/core/scheduler.py`
```python
# Line ~120-125
unreviewed_cutoff = now - timedelta(days=90)    # ุบูุฑ ุงููุฑุงุฌุนุฉ
reviewed_cutoff = now - timedelta(days=180)     # ุงููุฑุงุฌุนุฉ
low_confidence_cutoff = now - timedelta(days=30) # ุถุนููุฉ ุงูุซูุฉ
```

### ูู `cleanup_old_cards.py`
```python
# Line ~265
stats = await service.run_full_cleanup(
    unreviewed_days=90,      # ุบูุฑ ุงููุฑุงุฌุนุฉ
    reviewed_days=180,       # ุงููุฑุงุฌุนุฉ
    low_confidence_days=30,  # ุถุนููุฉ ุงูุซูุฉ
    min_confidence=50.0      # ุงูุญุฏ ุงูุฃุฏูู ููุซูุฉ
)
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุงููุงูู
```bash
cd backend
python test_card_cleanup.py
```

**ุงูุงุฎุชุจุงุฑ ูููู ุจู:**
1. ุฅูุดุงุก 4 ุจุทุงูุงุช ุชุฌุฑูุจูุฉ (ูุฏููุฉุ ุญุฏูุซุฉุ ุถุนููุฉ)
2. ุชุดุบูู ุงูุชูุธูู
3. ุงูุชุญูู ูู ุงููุชุงุฆุฌ
4. ุนุฑุถ ุฅุญุตุงุฆูุงุช ููุตูุฉ

---

## ๐ ุงููููุงุช ุงููุถุงูุฉ

```
backend/
โโโ cleanup_old_cards.py           # ุณูุฑุจุช ุงูุชูุธูู ุงููุฏูู
โโโ test_card_cleanup.py           # ุงุฎุชุจุงุฑ ุงููุธุงู
โโโ app/
    โโโ core/
        โโโ scheduler.py           # ุชุญุฏูุซ: ุฃุถููุง cleanup_old_cards_task
```

---

## ๐ ุงููุฑุงูุจุฉ

### ุนุฑุถ Logs
```bash
# ุนูู ุงูุณูุฑูุฑ
ssh root@46.62.239.119 "journalctl -u datapurity | grep 'cleanup'"

# ูุญููุงู - ุชุดุบูู ุงูุณูุฑูุฑ
uvicorn app.main:app --reload
```

ุณุชุดุงูุฏ:
```
INFO - Cards cleanup: Deleted 3 old cards from database
INFO - Cards cleanup: Deleted 2 orphaned files
```

---

## ๐ ุงููุดุฑ ุนูู ุงูุณูุฑูุฑ

### 1. ุฑูุน ุงูุชุญุฏูุซุงุช
```bash
cd d:\datapurity
git add .
git commit -m "Add card cleanup system with scheduler"
git push origin main
```

### 2. ุนูู ุงูุณูุฑูุฑ
```bash
ssh root@46.62.239.119
cd /opt/datapurity/backend
git pull
systemctl restart datapurity
```

### 3. ุงูุชุญูู
```bash
# ุนุฑุถ ุงูู logs
journalctl -u datapurity -f

# ูุฌุจ ุฃู ุชุดุงูุฏ:
# "Marketing scheduler started successfully (interval: 60s, daily cleanup at 2 AM)"
```

---

## โฐ ุฌุฏูู ุงูุชูุธูู

| ุงููููุฉ | ุงูุชูููุช | ุงููุฏุฉ | ุงูุญุงูุฉ |
|--------|---------|-------|--------|
| **ุจุทุงูุงุช ุบูุฑ ูุฑุงุฌุนุฉ** | ููููุงู 2 AM | > 90 ููู | โ ูุดุท |
| **ุจุทุงูุงุช ูุฑุงุฌุนุฉ** | ููููุงู 2 AM | > 180 ููู | โ ูุดุท |
| **ุจุทุงูุงุช ุถุนููุฉ ุงูุซูุฉ** | ููููุงู 2 AM | > 30 ููู | โ ูุดุท |
| **ูููุงุช ูุชููุฉ** | ููููุงู 2 AM | > 24 ุณุงุนุฉ | โ ูุดุท |

---

## ๐ ุงูุฃูุงู

### ุญูุงูุฉ ูู ุงูุญุฐู ุงูุฎุงุทุฆ
- โ ูุญุฐู ููุท ุงูุจุทุงูุงุช ุงูุฃูุฏู ูู ุงููุฏุฉ ุงููุญุฏุฏุฉ
- โ ูุญุฐู ุงูููู ุฃููุงู ุซู ุงูุณุฌู
- โ ูุนุงููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (transactions)
- โ ุชุณุฌูู ูุงูู ููุนูููุงุช

### Rollback ูู ุญุงูุฉ ุงูุฎุทุฃ
```python
try:
    await db.delete(card)
    await db.commit()
except Exception as e:
    await db.rollback()
    logger.error(f"Error: {str(e)}")
```

---

## ๐ ุฅุญุตุงุฆูุงุช

### ุนุฑุถ ุงูุจุทุงูุงุช ุงูุญุงููุฉ
```python
from app.db.session import AsyncSessionLocal
from app.models.card import Card
from sqlalchemy import select, func

async with AsyncSessionLocal() as db:
    result = await db.execute(select(func.count(Card.id)))
    total = result.scalar()
    print(f"Total cards: {total}")
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุชูุธูู ูุง ูุนูู ุชููุงุฆูุงู
**ุงูุญู:**
```bash
# ุชุญูู ูู ุชูุนูู ุงูู scheduler
ssh root@46.62.239.119
journalctl -u datapurity | grep "scheduler"

# ูุฌุจ ุฃู ุชุดุงูุฏ:
# "Marketing scheduler started successfully"
```

### ุงููุดููุฉ: ุงููููุงุช ูุง ุชูุญุฐู
**ุงูุญู:**
```bash
# ุชุญูู ูู ุตูุงุญูุงุช ุงููุฌูุฏ
chmod -R 755 tmp/cards

# ุชุญูู ูู storage_path ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
sqlite3 datapurity.db "SELECT id, storage_path FROM cards LIMIT 5;"
```

---

## ๐ ุงูุฎูุงุตุฉ

**ุงููุธุงู ุฌุงูุฒ 100%!** ๐

- โ ุชูุธูู ุชููุงุฆู ููููุงู
- โ ุญุฐู ุขูู ูููููุงุช ูุงูุณุฌูุงุช
- โ ุชุณุฌูู ูุงูู ููุนูููุงุช
- โ ุงุฎุชุจุงุฑ ุดุงูู
- โ ุฌุงูุฒ ูููุดุฑ

---

## ๐ ุงูุชูุงุตู

ููุฃุณุฆูุฉ ุฃู ุงูุชุญุณููุงุช:
- ุฑุงุฌุน ุงูููุฏ ูู `cleanup_old_cards.py`
- ุดุบูู ุงูุงุฎุชุจุงุฑ: `python test_card_cleanup.py`
- ุฑุงุฌุน ุงูู logs: `journalctl -u datapurity -f`

---

ุชู ุจูุฌุงุญ! โจ
